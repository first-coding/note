- 网络层分为两个部分（SDN架构）：**它的核心思想是将网络的控制平面（Control Plane）和数据平面（Data Plane）分离开来，以实现更加灵活、可编程和可管理的网络。**
	- **数据平面（去做）**：负责数据包转发的过程中的一切操作，转发（通过路由表），过滤等操作。
	- **控制平面（怎么做）**：路由选择（配置路由表（路由表可以人工配置））、管理网络拓扑、配置网络设备以及响应网络事件。控制平面使用各种协议和算法来计算最佳的数据包路由路径，并将这些路由信息发送到数据平面中的网络设备。
- **网络服务模型**：定义分组在发送与接收端系统之间的端到端运输特性：
	- **确保交付**：确保分组最终到达目的地
	- **具有时延上界的确保交付**：确保同时，在特定的时延上界内交付。
	- **有序分组交付**：确保分组以发送的顺序到达目的地
	- **确保最小带宽**：确保某些应用程序或数据流能够在网络中获得至少指定的最低带宽，以满足其性能需求。
	- **安全性**：包括网络中的加密、身份验证、防火墙等功能，以保护数据在网络中的安全传输。
- **转发分为两类**：
	- **基于目的地的转发**：IP地址转发。
	- **通用转发**：通过数据报首部某些字段转发。
- **路由器工作原理**：
	- 通用路由器体系结构（分为4个组件）：![[Drawing 2023-08-30 15.45.43.excalidraw]]
		- **输入端口**：分为三个窗口，从左往右执行物理层，链路层，网络层功能，在第三个窗口不仅执行物理层的功能还需要执行网络层的功能，**查找路由表决定转发路由器的输出端口**。**分组**通过交换结构转发给输出端口。**控制分组（携带路由选择协议信息的分组）** 从输入端口转发到路由选择处理器中。![[Drawing 2023-09-01 15.08.56.excalidraw]]
			- 基于目的地转发：通过**最长前缀匹配规则**在转发表中寻找对应的前缀来匹配对应的链路接口。
			- 转发表从路由选择处理器经过独立的总线（PCI总线）复制到线路卡。通过复制其他的输入端口的转发表副本可以避免每个分组调用路由选择处理器。
			- 当多个分组到达输入端口的时候，并且交换结构不能让分组无时延通过的话，就会引起输入端口的排队。
		- **交换结构**：将输入端口连接到输出端口。分为三种交换技术
			- 交换方式：
				- **内存式**：![[Drawing 2023-08-30 17.04.19.excalidraw]]
				- **总线式**：![[Drawing 2023-08-30 17.13.06.excalidraw]]
				- **纵横式**：![[Drawing 2023-08-30 17.16.06.excalidraw]]
			- 交换技术：
				- **经内存交换**：输入与输出端口的功能类似I/O设备，一个分组到达，通过中断方式向路由选择处理器发出信号，分组被复制到内存中，路由选择器从首部中提取目的地址，在转发表中找出适当的输出端口并复制到输出端口的缓存中。如果内存带宽（**它表示在一段时间内从主存（RAM）中读取或写入数据的速度。内存带宽通常以每秒传输的数据量来衡量，单位通常是字节每秒（bytes per second）或比特每秒（bits per second），通常以GB/s（吉字节每秒）或MB/s（兆字节每秒）为单位。**）最多B个分组，那么总的转发吞吐量（分组从输入端口被传送到输出端口的总速率）必然小于B/2，**不能同时转发两个分组**
				- **经总线交换**：输入端口**经一根共享总线**将分组直接传送到输出端口，**不需要经过路由选择处理器**。输入端口为分组预先计划一个内部标签，所有的输出端口都可以收到，但只有与标签匹配的才能保存。一次只能一个分组。
				- **经互联网络交换**：交换结构控制器（交换结构自身的一部分）可以控制每个交叉点的开启和闭合，当需要进行传输分组的时候就会进行对应位置的闭合。只要转发分组使用**不同的总线**的话，就能够**并行转发**多个分组。
		- **输出端口**：输入端口存储从交换结构接收的分组。并执行链路层和物理层功能传输分组。![[Drawing 2023-09-01 15.22.51.excalidraw]]
			- **输入排队**：当缓存溢出的时候，新到达分组无法缓存。这时候有两个决定选择：
				- 丢弃到达的分组（采用一种**弃尾（drop-tail）** 的策略）。
				- 删除一个或多个已经排队的分组为新来分组腾出空间。
				- **主动队列管理（Active Queue Management，AQM）** 算法。
					- 随机早期检测算法（Random Early Detection，RED）是最为广泛和实现的算法。
					- 在特定情况下，在缓存填满之前丢弃一个分组（或在首部加上标记）可以向发送方拥塞信号。
		- **路由选择处理器**：
			- **在传统路由器中**：执行路由选择协议，维护路由选择表与关联链路状态信息。
			- **在SDN路由器中**：路由选择处理器负责与远程控制器通信，接收远程控制器计算的转发表，并在路由器输入端口安装这些表项。
			- 执行网络管理功能。
	- **分组调度（packet scheduler）**：在排队分组中选择一个分组来传输。
		- **先进先出（First-In-First-Out，FIFO）**：按照分组到达输出链路队列的相同次序来选择分组在链路上的传输。
		- **优先权排队（priority queuing）**：到达输出链路的分组根据类型一些信息分类放入输出队列中的不同优先权队列，在同一优先权队列中按照FIFO（先进先出）的方式进行传输。高优先权优先。按照**非抢占式优先权排队（non-preemptive priority queuing）** 规则中，一旦分组开始运输就不能打断（与优先权无关）。
		- **循环和加权公平排队**：分组像使用优先权排队那样被分类，没有严格的服务优先权，循环调度器在类之间轮流提供服务，最简单的方式就是，先类1，之后类2，依次执行并循环。**保持工作排队（work-conseving queuing）** 规则在有分组排队等待传输时，不允许链路保持空闲。
			- **加权公平排队（Weighted Fair Queuing，WFQ）规则** ：到达的分组被分类并在合适的每个类等待区域排队，WFQ也是用循环的方式为每个类提供服务，每个类被分配一个权ωi，使用WFQ方式，在任何时间间隔中，**第i类确保接收到服务部分等于ωi/（Σωj）**，分母的和是计算所有有分组等待传输的类别。最坏情况，**每个类都有分组进行排队。这样每一个类仍然保证分配到带宽的ωi/（Σωj）部分，对于一条传输速率为R的链路，每个类都能获得   R . ωi/（Σωj）的吞吐量，** 这是理想化情况，因为存在一个事实：**分组时离散的数据单元，并且不能打断一个分组的传输来开始传输另一个分组。** 
- **协议**：
	- IPv4数据报文格式：![[计算机网络-数据平面 2023-09-02 14.31.27.excalidraw]]
	- **不同的链路层协议能承载不同长度的网络层分组**。以太网帧承载不超过1500字节数据，某些广域网链路的帧不超过576字节。**最大传送单元（Maximum Transmission Unit，MTU）** 链路层帧能承载的最大数据量。
	- **IPV4数据报分片**：当某链路的MTU比数据报长度要小，将数据报的数据分片为两个或多个较小的IP数据报，用单独的链路层帧封装这些较小的IP数据报之后发送。**这些小的数据报叫做片**。接收端重新组装这些数据报分片。
		- 发送主机将发送的每个数据报**标识号**加1。路由器要分片时，每个片具有相同的标识号。
		- 每个片**标志**比特设置为1，除了最后一个片的**标志**设置为0。
		- **偏移字段**指定该片放在IP数据报的哪个位置。
	- **IPV4编址**：
		- **接口**：主机/路由器与物理链路之间的边界。
		- **IPV4地址**：每个IP地址长度为32比特，总共有2^32个可能的IP地址。
		- **点分十进制记法（dotted-decimal notation）**：每个字节用十进制表示，各字节间用句点(.)隔开。
		- **子网**：分开主机和路由器的每个接口，产生几个隔离的网络，这些隔离的网络叫做子网
		- **子网掩码**：将IP地址的网络部分和主机部分分开来，也可以理解为子网的标识。
		- **无类别域间路由选择（Classless Interdomain Routing，CIDR）** 
			- 通过使用（/加一个数字），来表示网络部分（也叫前缀），在CIDR之前，IPV4采用类别化方式，分为A，B，C，D类等。
			- 具有相同前缀的路由可以聚合一个单一路由表条目。
			- **无类别路由选择**：允许路由器根据前缀长度决定最佳的路由选择。
			- **路由聚合，地址聚合，路由摘要**：使用单个网络前缀通告多个网络的能力。
			- ![[计算机网络-数据平面 2023-09-03 18.05.32.excalidraw]]
			- ![[Drawing 2023-09-03 18.30.28.excalidraw]]
		- **DHCP(动态主机配置协议)**：允许主机自动获取（被分配）一个IP地址，网络管理员可以配置DHCP。过程如下：
			- **DHCP服务器发现**：新到达的主机通过广播的方式，UDP分组向端口67发送DHCP发送报文
			- **DHCP服务器提供**：DHCP服务器收到发现报文，通过向子网的所有节点广播用DHCP提供报文向客户做出响应。**（报文中包含发现报文的事务ID，推荐的IP地址，网络掩码以及IP地址租用期（IP地址有效的时间量））**
			- **DHCP请求**：从一个或多个服务器提供选择一个，并向选中的服务器提供DHCP请求报文进行响应，回显配置的参数。
			-  **DHCP ACK**：服务器用DHCP ACK对DHCP请求报文进行响应，证实所要求的参数。
		- **网络地址转换（Network Address Translation,NAT）**：私有地址转换成公有地址的协议。通过NAT转换表来对公网来的分组进行转发给内部主机。例子如下：
			- ![[计算机网络-数据平面 2023-09-05 16.01.42.excalidraw]]
	- **IPV6**：地址不够开发出IPV6
		- IPV6数据报格式：![[Drawing 2023-09-05 16.50.59.excalidraw]]
		- IPV4存在，IPV6不存在：
			- IPV6不可以分片，如果数据报太大不能转发到链路的话，就丢弃，向发送方返回分组太大的ICMP差错报文。发送方使用较小长度的IP数据报重发。
			- 首部检验和：运输层和数据链路层的协议执行了检验了，所以IPV6去掉了首部检验和
			- 选项
		- IPV4到IPV6迁移：通过建隧道的方式，将IPV6数据报整个放入IPV4报文中进行通信。
- PS：
	- 路由器不运行应用层和运输层的协议。
	- **单播**：一对一通信
	- **多播**：一对多通信
	- **广播**：对某一个网络上的所有主机发送数据报